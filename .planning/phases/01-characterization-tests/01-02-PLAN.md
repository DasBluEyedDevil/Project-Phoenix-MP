---
phase: 01-characterization-tests
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - shared/src/commonTest/kotlin/com/devil/phoenixproject/presentation/manager/DWSMRoutineFlowTest.kt
autonomous: true

must_haves:
  truths:
    - "Running ./gradlew :shared:testDebugUnitTest executes routine flow characterization tests that pass"
    - "Tests lock in loadRoutine behavior (async weight resolution, sets RoutineFlowState.Overview)"
    - "Tests lock in enterSetReady behavior (updates RoutineFlowState.SetReady with correct params)"
    - "Tests lock in advanceToNextExercise / jumpToExercise navigation"
    - "Tests lock in superset navigation (getCurrentSupersetExercises, getNextSupersetExercise)"
    - "Tests lock in skipCurrentExercise and goToPreviousExercise"
  artifacts:
    - path: "shared/src/commonTest/kotlin/com/devil/phoenixproject/presentation/manager/DWSMRoutineFlowTest.kt"
      provides: "Characterization tests for routine flow behavior"
      contains: "class DWSMRoutineFlowTest"
  key_links:
    - from: "DWSMRoutineFlowTest.kt"
      to: "DWSMTestHarness.kt"
      via: "harness construction and WorkoutStateFixtures usage"
      pattern: "DWSMTestHarness\\(this\\)|WorkoutStateFixtures"
    - from: "DWSMRoutineFlowTest.kt"
      to: "DefaultWorkoutSessionManager"
      via: "public API calls (loadRoutine, enterSetReady, advanceToNextExercise, etc.)"
      pattern: "harness\\.dwsm\\."
---

<objective>
Write routine flow characterization tests using the DWSMTestHarness and WorkoutStateFixtures built in Plan 01-01.

Purpose: Lock in routine flow behavior (load routine, set navigation, exercise advancement, superset flow) so Phase 2 RoutineFlowManager extraction can proceed without regression.

Output: DWSMRoutineFlowTest.kt -- all passing in commonTest.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-characterization-tests/01-RESEARCH.md
@.planning/phases/01-characterization-tests/01-01-SUMMARY.md

@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/DefaultWorkoutSessionManager.kt
@shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/DWSMTestHarness.kt
@shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/WorkoutStateFixtures.kt
@shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/TestFixtures.kt
@shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/FakeBleRepository.kt
@shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/FakeExerciseRepository.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Routine flow characterization tests</name>
  <files>
    shared/src/commonTest/kotlin/com/devil/phoenixproject/presentation/manager/DWSMRoutineFlowTest.kt
  </files>
  <action>
Create DWSMRoutineFlowTest.kt with characterization tests that lock in current routine flow behavior. Use DWSMTestHarness and WorkoutStateFixtures from Plan 01-01.

**Test categories (minimum tests per category):**

**A. loadRoutine (3-4 tests):**
- `loadRoutine_setsRoutineFlowStateToOverview`: Call loadRoutine with createTestRoutine(), advanceUntilIdle(), assert routineFlowState.value is RoutineFlowState.Overview
- `loadRoutine_resolvesWeightsFromPRs`: Seed FakePersonalRecordRepository with a PR for the first exercise, call loadRoutine, advanceUntilIdle(), verify the resolved weight reflects PR data (check via entering set ready and inspecting adjustedWeight)
- `loadRoutine_setsFirstExerciseParams`: After loadRoutine + advanceUntilIdle(), check that workoutParameters.value matches the first exercise in the routine (weightPerCableKg, reps, selectedExerciseId)
- `loadRoutine_isAsync_stateNotImmediatelyAvailable`: Call loadRoutine WITHOUT advanceUntilIdle(), assert routineFlowState.value is still NotInRoutine (or whatever the pre-load state is). Then advanceUntilIdle() and assert Overview. This locks in the async nature per Pitfall 3.

**B. enterSetReady (3-4 tests):**
- `enterSetReady_updatesRoutineFlowState`: Use setReadyDWSM fixture or loadRoutine + advanceUntilIdle, call enterSetReady(0, 0), assert routineFlowState is SetReady with exerciseIndex=0, setIndex=0
- `enterSetReady_setsCorrectWeightAndReps`: Assert SetReady state has adjustedWeight matching routine exercise weight and adjustedReps matching routine exercise reps
- `enterSetReady_detectsAMRAP`: Create a routine with reps=0 (AMRAP) for one exercise, loadRoutine, enterSetReady for that exercise, verify isAMRAP flag or reps=0 in the SetReady state
- `enterSetReady_secondSet_incrementsSetIndex`: loadRoutine, enterSetReady(0, 0), then enterSetReady(0, 1), assert setIndex=1 in the new SetReady state

**C. advanceToNextExercise / jumpToExercise (3-4 tests):**
- `advanceToNextExercise_movesToNextExerciseIndex`: loadRoutine with 3 exercises, enterSetReady(0, 0), simulate a workout + stop (so current exercise completes), then call advanceToNextExercise(), advanceUntilIdle(), verify state reflects exercise index 1
- `jumpToExercise_navigatesToSpecificIndex`: loadRoutine, jumpToExercise(2), advanceUntilIdle(), verify exercise index is 2
- `skipCurrentExercise_advancesToNext`: loadRoutine, enterSetReady(0, 0), skipCurrentExercise(), advanceUntilIdle(), verify exercise index advanced
- `goToPreviousExercise_navigatesBackward`: loadRoutine, enterSetReady(1, 0) (or advance to exercise 1), goToPreviousExercise(), advanceUntilIdle(), verify exercise index is 0

**D. Superset navigation (3-4 tests):**
- `getCurrentSupersetExercises_returnsExercisesInSuperset`: loadRoutine with createSupersetRoutine(), enterSetReady for first superset exercise, call getCurrentSupersetExercises(), assert returns the 2 exercises in the superset
- `getNextSupersetExercise_returnsNextInChain`: After setting up superset routine, verify getNextSupersetExercise() returns the second exercise in the superset
- `supersetNavigation_afterLastExerciseInSuperset_movesToNonSupersetExercise`: Navigate through both exercises in the superset, then advance -- should move to the non-superset exercise

**E. enterRoutineOverview / selectExerciseInOverview (2 tests):**
- `enterRoutineOverview_setsOverviewState`: loadRoutine, enterSetReady(0, 0), enterRoutineOverview(routine), assert routineFlowState is Overview
- `selectExerciseInOverview_updatesSelectedIndex`: After enterRoutineOverview, call selectExerciseInOverview(1), verify selectedExerciseIndex updates

**Pattern for all tests:**
```kotlin
@Test
fun testName() = runTest {
    val harness = DWSMTestHarness(this)
    val routine = WorkoutStateFixtures.createTestRoutine()
    routine.exercises.forEach { harness.fakeExerciseRepo.addExercise(it.exercise) }

    harness.dwsm.loadRoutine(routine)
    advanceUntilIdle()
    // ... actions and assertions ...
}
```

**CRITICAL:** Always seed FakeExerciseRepository with exercises used in the routine (Pitfall 6). Always advanceUntilIdle() after loadRoutine() (Pitfall 3).

**CRITICAL:** For navigation tests that involve jumpToExercise -- this method calls BLE stop internally. The FakeBleRepository handles this fine, but advanceUntilIdle() is needed after the call.

**CRITICAL:** These are characterization tests. Lock in actual behavior. If superset navigation does something unexpected, assert what it actually does and comment.

**CRITICAL:** Do NOT modify any production code. Zero changes to src/commonMain/.

**NOTE:** Some navigation tests may need the DWSM to be in a connected state (for BLE commands during jumps). Use `harness.fakeBleRepo.simulateConnect("Vee_Test")` where needed.
  </action>
  <verify>
Run `./gradlew :shared:testDebugUnitTest --tests "com.devil.phoenixproject.presentation.manager.DWSMRoutineFlowTest"` -- all tests pass. Then run `./gradlew :shared:testDebugUnitTest` to verify no existing tests broke.
  </verify>
  <done>
At least 14 characterization tests pass covering loadRoutine, enterSetReady, advanceToNextExercise, jumpToExercise, skipCurrentExercise, goToPreviousExercise, superset navigation, enterRoutineOverview, and selectExerciseInOverview. All tests run in commonTest with no platform dependencies. All existing tests still pass.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew :shared:testDebugUnitTest` -- ALL tests pass (new + existing + Plan 01-01 tests)
2. DWSMRoutineFlowTest has >= 14 passing tests
3. Zero modifications to any file under shared/src/commonMain/
4. Combined with Plan 01-01, all four requirements are satisfied: TEST-01, TEST-02, TEST-03, TEST-04
</verification>

<success_criteria>
- Routine flow behavior is locked in by passing characterization tests
- TEST-02 (routine flow) requirement is satisfied
- Combined with Plan 01-01: all Phase 1 success criteria from ROADMAP.md are met
- Phase 2 Manager Decomposition can proceed safely with full characterization test coverage
</success_criteria>

<output>
After completion, create `.planning/phases/01-characterization-tests/01-02-SUMMARY.md`
</output>
